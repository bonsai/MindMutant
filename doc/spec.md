# System Specifications

### 1. 生物学的メタファー
本システムは単なる単語の組み合わせではなく、生物の進化を模倣する。

- **交配 (Crossover)**:
  - 単語同士が出会うと「子供」が生まれる。
  - 子供の単語は親の特徴を受け継ぎつつ、親より多少長くなる傾向を持つ（複合語化など）。
- **血縁制御 (Kinship)**:
  - 近親交配（類似度が高すぎる、あるいは同じ親を持つなど）は回避される。
- **寿命と淘汰**:
  - 単語は基本的には死なない（不死）。次世代には前世代の全個体がコピーされる。
  - ただし、**3世代に1回、大規模な災害イベント**が発生する。
  - **環境収容力 (Carrying Capacity)**:
    - 個体数には上限（**MAX_POPULATION = 50**）が設定される。
    - 子供の生成による個体増加は、この上限を超えない範囲で行われる。

  - **淘汰基準 (Natural Selection)**:
    - 災害時には個体数の半数が死亡する。
    - 生存競争の基準は **Novelty（意外性）** である。
    - Noveltyが低い（平凡な）個体は「弱い」とみなされ、優先的に淘汰される。
    - 特に、**重複する単語や類似度が極端に高い単語**はNoveltyが著しく低くなるため、真っ先に淘汰される（多様性の維持）。
  - 新たな子供が個体群に追加されるため、世代が進むごとに個体数は増加するが、災害により定期的に抑制される。
  - 親として選ばれるかどうかは確率（または適応度）に依存する。
- **世代管理 (Generation)**:
  - 各世代（G）のメタデータを保持し、進化の軌跡を追跡可能にする。

### 2. アルゴリズム設計
- **初期化**: `data/g0/` 配下の JSON から特定ドメイン（IT, Agri, Edu 等）の単語をロードし、初期個体を生成。
- **評価関数 (Fitness)**:
  - **Novelty**: ベクトル距離による意外性。
  - **Coherence**: 文脈的成立度。

### 3. データ構造 (Data Structure)
- **`data/g0/`**:
  - ドメインごとのソース単語リスト（`*.json`）。
  - 初期世代の個体リスト (`population.json`) もここに生成される。
- **`data/g{N}/`** (N >= 1):
  - 世代ごとのスナップショット。
  - `population.json`: 個体リスト（ID, Content, Parents, Fitness）。
  - `metadata.json`: 世代メタデータ（個体数, 生成日時）。

### 4. 目的と連携 (Purpose & Integration)
- **プロンプトの種 (Prompt Seeds)**:
  - 生成された単語（およびその組み合わせ）は、将来的にLLMへのプロンプトの種（Seed）として使用される。
  - 本システム（GA）は、単語の組み合わせを進化させ、「いい感じ」の組み合わせ（Novelty & Coherence）を探索・保存することに特化する。
  - **ストーリー生成プロンプト機能**:
    - 可視化されたHTML上で単語を選択し、それらを用いたストーリー生成用のプロンプトをワンクリックで作成・コピーできる機能を提供する。
- **可視化 (Visualization)**:
  - 各世代の生成結果を直感的に把握するため、HTML形式のタグクラウド (`cloud.html`) を生成する。
  - これにより、ユーザーは進化の過程でどのような単語の組み合わせが出現しているかを視覚的に確認できる。

### 5. 特徴量抽出と分析 (Feature Extraction & Analysis)
`situation.json` に含まれるベクトルデータを用いて、世代ごとの個体群の特徴を抽出・分析する。

- **アーキテクチャ**:
  - **Analyzer** (`gen/ga/analyzer.py`): 分析プロセスの統括。
  - **Evaluator** (`gen/nlp/evaluator.py`): 個体間の距離計算（最近傍・最遠傍探索）。
  - **FitnessScore** (`gen/fitness/score.py`): 各種スコア計算。

- **ベクトル化**:
  - 各個体（単語）の意味内容を多次元ベクトル（Spacy等を利用）に変換し、`vectors` として保持する。

- **評価指標**:
  - **Novelty (意外性)**: 最近傍個体との距離から算出 (`1.0 - similarity`)。既存の概念からどれだけ離れているかを示す。

### 6. 運用機能 (Operations)
- **単語継ぎ足し (Word Injection)**:
  - 進化の途中でも外部から新しい単語を投入可能にする。
  - `data/addwords.csv` に単語を記述しておくと、次世代生成時にそれらが「移住者」として個体群に追加される。
  - 処理後、CSVファイルはアーカイブディレクトリ (`data/poll/`) へ移動される。

- **可視化とプロンプト抽出**:
  - `wordcrowd.html` では、Noveltyスコアが高い単語ほど大きく表示される。
  - HTML上で単語を選択（クリック）し、"Generate & Copy Prompt" ボタンを押すことで、選択した単語群を用いたストーリー生成プロンプトを取得できる。

- **災害の強制発動**:
  - CLIオプション `--die` を使用することで、通常の周期（3世代ごと）に関わらず、強制的に災害イベントを引き起こすことができる。
  - これにより、個体数が増えすぎた場合や、ドラスティックな変化を求めるときに、人為的な介入が可能となる。
